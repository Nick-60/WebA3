<!-- 与 backend/src/main/resources/static/hr_report.html 相同，用于预览与同步 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HR 报表导出 | Leave System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <a class="navbar-brand" href="/dashboard.html">返回仪表盘</a>
  </nav>
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <h1>HR 报表导出</h1>
      </div>
    </section>
    <section class="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-body">
            <div class="form-row">
              <div class="form-group col-md-3">
                <label>开始日期</label>
                <input type="date" id="fromDate" class="form-control">
              </div>
              <div class="form-group col-md-3">
                <label>结束日期</label>
                <input type="date" id="toDate" class="form-control">
              </div>
              <div class="form-group col-md-3">
                <label>部门ID（可选）</label>
                <input type="number" id="departmentId" class="form-control" placeholder="例如 1">
              </div>
              <div class="form-group col-md-3" style="margin-top: 32px;">
                <button class="btn btn-primary" id="exportBtn">导出 XLSX</button>
              </div>
            </div>
            <p class="text-muted">不填日期则导出最近 30 天。</p>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
<script src="/js/ui.js"></script>
<script src="/js/config.js"></script>
<script src="/js/auth.js"></script>
<script>
  (function ensureLogin() {
    if (!getToken()) {
      alert('请先登录');
      window.location.href = '/login.html';
    }
  })();

  function defaultDateRange() {
    const today = new Date();
    const to = today.toISOString().slice(0,10);
    const fromDate = new Date();
    fromDate.setDate(today.getDate() - 30);
    const from = fromDate.toISOString().slice(0,10);
    return { from, to };
  }

  document.getElementById('exportBtn').addEventListener('click', async () => {
    const from = document.getElementById('fromDate').value || defaultDateRange().from;
    const to = document.getElementById('toDate').value || defaultDateRange().to;
    const departmentId = document.getElementById('departmentId').value;
    try {
      const blob = await exportHrReport({ from, to, departmentId: departmentId || undefined });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hr_report_${from}_${to}${departmentId?('_dept'+departmentId):''}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      alert('导出成功，已开始下载');
    } catch (err) {
      alert('导出失败：' + (err?.response?.data?.message || err.message));
    }
  });
</script>
</body>
</html>

