<!-- 与 backend/src/main/resources/static/hr_report.html 相同，用于预览与同步 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HR 报表导出 | Leave System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="hold-transition layout-top-nav">
<div class="wrapper">
  <nav class="main-header navbar navbar-expand navbar-white navbar-light"><div id="navMount"></div></nav>
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <h1>HR Reports</h1>
      </div>
    </section>
    <section class="content">
      <main class="container-fluid">
        <div class="card u-card u-card-elevated">
          <div class="card-body">
            <div class="form-row">
              <div class="form-group col-md-3">
                <label>Start Date</label>
                <input type="date" id="fromDate" class="form-control">
              </div>
              <div class="form-group col-md-3">
                <label>End Date</label>
                <input type="date" id="toDate" class="form-control">
              </div>
              <div class="form-group col-md-3">
                <label>Department ID (optional)</label>
                <input type="number" id="departmentId" class="form-control" placeholder="e.g. 1">
              </div>
              <div class="form-group col-md-3 u-mt-6">
                <button class="btn btn-primary" id="exportBtn">Export XLSX</button>
              </div>
            </div>
            <p class="text-muted">If dates are empty, exports the last 30 days.</p>
          </div>
        </div>
      </main>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
<script src="/js/ui.js"></script>
<script src="/js/config.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/nav.js"></script>
<script>
  (function ensureLogin() {
    if (!getToken()) {
      showError('Please sign in first');
      window.location.href = '/login.html';
    }
  })();

  (async function ensureRole(){
    try{
      const p = await fetchProfile();
      if (!p || p.role !== 'HR') {
        showError('仅 HR 角色可访问报表导出');
        setTimeout(function(){ window.location.href='/dashboard.html' }, 800);
      }
    }catch(e){ /* 已在拦截器提示 */ }
  })();

  function defaultDateRange() {
    const today = new Date();
    const to = today.toISOString().slice(0,10);
    const fromDate = new Date();
    fromDate.setDate(today.getDate() - 30);
    const from = fromDate.toISOString().slice(0,10);
    return { from, to };
  }

  document.getElementById('exportBtn').addEventListener('click', async () => {
    const from = document.getElementById('fromDate').value || defaultDateRange().from;
    const to = document.getElementById('toDate').value || defaultDateRange().to;
    const departmentId = document.getElementById('departmentId').value;
    try {
      const btn = document.getElementById('exportBtn');
      const blob = await withButtonLoading(btn, () => exportHrReport({ from, to, departmentId: departmentId || undefined }));
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hr_report_${from}_${to}${departmentId?('_dept'+departmentId):''}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      showSuccess('Export succeeded. Download started.');
    } catch (err) {
      showError('Export failed: ' + ((err && err.response && err.response.data && err.response.data.message) ? err.response.data.message : err.message));
    }
  });
</script>
</body>
</html>
