<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Submit Leave | Leave System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <a class="navbar-brand" href="/dashboard.html">Back to Dashboard</a>
  </nav>
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <h1>Submit Leave</h1>
      </div>
    </section>
    <section class="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-body">
            <form id="leaveForm">
              <div class="form-group">
                <label>Leave Type</label>
                <select id="leaveType" class="form-control" required>
                  <option value="ANNUAL">Annual Leave</option>
                  <option value="SICK">Sick Leave</option>
                  <option value="UNPAID">Unpaid Leave</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label>Start Date</label>
                <div class="u-input-wrapper">
                  <input type="text" id="startDate" class="form-control u-input-with-icon" required placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" inputmode="numeric" autocomplete="off">
                  <button type="button" id="startDateIcon" class="u-input-icon-btn" aria-label="Open calendar">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1V3a1 1 0 0 1 1-1zm13 7H4v10a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V9zM6 7h12V6a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v1z"></path></svg>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>End Date</label>
                <div class="u-input-wrapper">
                  <input type="text" id="endDate" class="form-control u-input-with-icon" required placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" inputmode="numeric" autocomplete="off">
                  <button type="button" id="endDateIcon" class="u-input-icon-btn" aria-label="Open calendar">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1V3a1 1 0 0 1 1-1zm13 7H4v10a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V9zM6 7h12V6a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v1z"></path></svg>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Comment</label>
                <textarea id="comment" class="form-control" rows="3" placeholder="optional"></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Submit</button>
            </form>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
<script src="/js/ui.js"></script>
<script src="/js/config.js"></script>
<script src="/js/auth.js"></script>
<script>
  (function ensureLogin() {
    if (!getToken()) {
      showError('Please sign in first');
      window.location.href = '/login.html';
    }
  })();

  const form = document.getElementById('leaveForm');
  let startPicker, endPicker;
  function initPickers(){
    if (!window.flatpickr) return;
    const opts = { dateFormat: 'Y-m-d', locale: 'en', allowInput: true };
    startPicker = startPicker || window.flatpickr('#startDate', opts);
    endPicker = endPicker || window.flatpickr('#endDate', opts);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPickers);
  } else {
    initPickers();
  }
  (function waitForFlatpickr(){
    let tries = 0; const t = setInterval(function(){
      if (window.flatpickr) { initPickers(); clearInterval(t) }
      else if (++tries > 20) { clearInterval(t) }
    }, 100);
  })();
  document.getElementById('startDateIcon') && document.getElementById('startDateIcon').addEventListener('click', function(){
    if (startPicker && typeof startPicker.open==='function') { startPicker.open(); return }
    if (window.flatpickr) { initPickers(); if (startPicker && startPicker.open) startPicker.open(); else document.getElementById('startDate').focus() }
    else { document.getElementById('startDate').focus() }
  });
  document.getElementById('endDateIcon') && document.getElementById('endDateIcon').addEventListener('click', function(){
    if (endPicker && typeof endPicker.open==='function') { endPicker.open(); return }
    if (window.flatpickr) { initPickers(); if (endPicker && endPicker.open) endPicker.open(); else document.getElementById('endDate').focus() }
    else { document.getElementById('endDate').focus() }
  });
  form.addEventListener('submit', async (evt) => {
    evt.preventDefault();
    const re = /^\d{4}-\d{2}-\d{2}$/;
    const s = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    if(!re.test(s) || !re.test(endVal)) { showError('Please enter dates as YYYY-MM-DD'); return }
    const dto = {
      leave_type: document.getElementById('leaveType').value,
      start_date: s,
      end_date: endVal,
      comment: document.getElementById('comment').value.trim(),
    };
    try {
      const resp = await createLeaveRequest(dto);
      if (resp && resp.code === 0) {
        showSuccess('Submitted successfully. ID: ' + (resp.data?.id || ''));
        setTimeout(() => window.location.href = '/dashboard.html', 800);
      } else {
        showError(resp?.message || 'Submit failed');
      }
    } catch (err) {
      showError('Submit failed: ' + (err?.response?.data?.message || err.message));
    }
  });
</script>
</body>
</html>

